<!DOCTYPE html>

<html>
<head>
  <title>graph.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="findCars.html">
                findCars.js
              </a>
            
              
              <a class="source" href="app.html">
                app.js
              </a>
            
              
              <a class="source" href="calculate.html">
                calculate.js
              </a>
            
              
              <a class="source" href="graph.html">
                graph.js
              </a>
            
              
              <a class="source" href="lib.html">
                lib.js
              </a>
            
              
              <a class="source" href="scripts.html">
                scripts.js
              </a>
            
              
              <a class="source" href="upload.html">
                upload.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>graph.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>class for creating and animating the graph (and it&#39;s timeline)</p>
<p>constructor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> Graph = <span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>car data and each individual car2go found in portland by license</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.cars = window.cars;
  <span class="keyword">this</span>.ids = Object.keys(<span class="keyword">this</span>.cars);</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>the number of days tracked</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.nDays = app.data.numDays;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>the timestamp intervals in ms being tracked</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.interval = <span class="number">600000</span>; <span class="comment">// 10 minutes</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>the interval to update the graph with</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.speed = <span class="number">200</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>the start of it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.start = <span class="keyword">new</span> Date(app.data.start);</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>set the timestamp to be a clone of a date object at the first start</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.timestamp = +<span class="keyword">this</span>.start;
  <span class="keyword">this</span>.end = app.data.end;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>get elements</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.gather();</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>attach to elements</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.attach();</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>get configuration for mapreduce and calculate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.stats = <span class="keyword">this</span>.defineStats();
};</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>gather elements &amp; element-related functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Graph.prototype.gather = <span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>parent element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.container = d3.select(<span class="string">'#map'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>create an svg element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.svg = <span class="keyword">this</span>.svg ||
    <span class="keyword">this</span>.container.append(<span class="string">'svg'</span>).attr(<span class="string">'id'</span>, <span class="string">'map-graph'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>the count text</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.count = d3.select(<span class="string">'#count'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>time elements</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.day = {
    element: d3.select(<span class="string">'#day'</span>),</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>{day of week}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    format: d3.time.format(<span class="string">'%A'</span>)
  };
  <span class="keyword">this</span>.time = {
    element: d3.select(<span class="string">'#time'</span>),</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>{12hour,space padded:minute} {AM/PM}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    format: d3.time.format(<span class="string">'%_I:%M %p'</span>)
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>timeline element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.timeline = d3.select(<span class="string">'#timeline'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>height of the timeline element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.timeline.height = parseInt(
    <span class="keyword">this</span>.timeline.style(<span class="string">'height'</span>).replace(<span class="regexp">/px/</span>, <span class="string">''</span>)
  );</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>collect scales</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.getScales();
};</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>collect scales based on browser size</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Graph.prototype.getScales = <span class="keyword">function</span>() {
  <span class="keyword">this</span>.xscale = d3.scale.linear()
    .domain([+<span class="keyword">this</span>.start, <span class="keyword">this</span>.end])
    .range([<span class="number">0</span>, window.innerWidth]);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>attach events to handlers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Graph.prototype.attach = <span class="keyword">function</span>() {
  <span class="keyword">var</span> thiz = <span class="keyword">this</span>;
  <span class="keyword">var</span> timeline = <span class="keyword">this</span>.timeline.node();</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>take an event object and update the cars at the found x location</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> getX = <span class="keyword">function</span>(e) {
    <span class="keyword">var</span> x = e.pageX || e.clientX;
    <span class="keyword">var</span> timestamp = thiz.xscale.invert(x);
    thiz.timestamp = +<span class="keyword">new</span> Date(timestamp).getTenth();

    thiz.stopAnimating = <span class="literal">true</span>;
    thiz.update(thiz.timestamp);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>mouse move over the timeline</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  timeline.addEventListener(<span class="string">'mousemove'</span>, throttle(getX, <span class="number">15</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>touchmove on the timeline to update it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  timeline.addEventListener(<span class="string">'touchmove'</span>, throttle(getX, <span class="number">15</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>touchstart on the timeline to stop updating</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  timeline.addEventListener(<span class="string">'touchstart'</span>, <span class="keyword">function</span>(e) {
    e.preventDefault();
    getX(e);
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>touchend on the timeline to continue animating</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  timeline.addEventListener(<span class="string">'touchend'</span>, <span class="keyword">function</span>(e) {
    e.preventDefault();
    thiz.stopAnimating = <span class="literal">false</span>;
    thiz.animate();
  });

  <span class="keyword">this</span>.container.node().addEventListener(<span class="string">'mouseover'</span>, <span class="keyword">function</span>() {
    thiz.stopAnimating = <span class="literal">false</span>;
    thiz.animate();
  });

  window.addEventListener(<span class="string">'resize'</span>, throttle(<span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>cache the current timestamp</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> timestamp = thiz.timestamp;</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>update the timeline</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    thiz.getScales();
    thiz.drawTimepath();
    thiz.drawTimeline();</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>update the timestamp</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    thiz.timestamp = timestamp;
  }, <span class="number">25</span>));
};</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>draws the axis and ticks under the map</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Graph.prototype.drawTimeline = <span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>clear any ticks previously drawn</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.timeline.select(<span class="string">'.tick-container'</span>).remove();

  <span class="keyword">var</span> start = +<span class="keyword">this</span>.start;
  <span class="keyword">var</span> end = <span class="keyword">this</span>.end;

  <span class="keyword">var</span> container = <span class="keyword">this</span>.timeline.append(<span class="string">'svg:g'</span>)
    .attr({
      <span class="string">'class'</span>: <span class="string">'tick-container'</span>,
    })</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>number of ticks we need</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> ticks = (end - start) / <span class="keyword">this</span>.interval;</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>iterate from the first interval to the number of ticks found
don&#39;t start at 0 to prevent drawing a tick on the left side of the page</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt; ticks; i++) {
    <span class="keyword">var</span> attrs = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>small tick = every % 6 (1 hour)
big tick = every % 36 (6 hours)
divider = every day % 144 (24 hours)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (i % <span class="number">144</span> == <span class="number">0</span>) {
      attrs = {
        <span class="string">'class'</span>: <span class="string">'divider'</span>,
        <span class="string">'y1'</span>: <span class="keyword">this</span>.timeline.height - <span class="number">30</span>
      };
    }
    <span class="keyword">else</span> <span class="keyword">if</span> (i % <span class="number">36</span> == <span class="number">0</span>) {
      attrs = {
        <span class="string">'class'</span>: <span class="string">'big-tick'</span>,
        <span class="string">'y1'</span>: <span class="keyword">this</span>.timeline.height - <span class="number">15</span>
      };
    }
    <span class="keyword">else</span> <span class="keyword">if</span> (i % <span class="number">6</span> == <span class="number">0</span>) {
      attrs = {
        <span class="string">'class'</span>: <span class="string">'small-tick'</span>,
        <span class="string">'y1'</span>: <span class="keyword">this</span>.timeline.height - <span class="number">5</span>
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>if we found an interval for the tick</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (attrs.y1 != <span class="literal">null</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>get the x-coordinate from the tick scale</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> x = <span class="keyword">this</span>.xscale(start + (i * <span class="keyword">this</span>.interval));</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>append a tick mark</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      container.append(<span class="string">'svg:line'</span>)
        .attr(attrs)
        .attr({
          <span class="string">'y2'</span>: <span class="keyword">this</span>.timeline.height,
          <span class="string">'x1'</span>: x,
          <span class="string">'x2'</span>: x
        })
    }
  }

  <span class="keyword">var</span> marker = d3.select(<span class="string">'.time-marker'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>if the marker doesn&#39;t exist yet, create it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> (marker.empty()) {
    marker = <span class="keyword">this</span>.timeline.append(<span class="string">'svg:line'</span>)
      .attr({
        <span class="string">'class'</span>: <span class="string">'time-marker'</span>,
        <span class="string">'y1'</span>: <span class="keyword">this</span>.timeline.height - <span class="number">20</span>,
        <span class="string">'y2'</span>: <span class="keyword">this</span>.timeline.height
      });
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>otherwise, move it in front of the ticks by re-appending it to the DOM</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">else</span> {
    marker.remove();
    <span class="keyword">this</span>.timeline.node().appendChild(marker.node());
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>draws the path element in the timeline</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Graph.prototype.drawTimepath = <span class="keyword">function</span>() {
  <span class="keyword">var</span> thiz = <span class="keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>yscale from 0 number cars found to the max num of cars is the
total number found in the dataset</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> yscale = d3.scale.linear()
    .domain([<span class="number">0</span>, <span class="keyword">this</span>.ids.length])
    .range([<span class="keyword">this</span>.timeline.height, <span class="number">0</span>]);</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>path function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> path = d3.svg.line()
    .x(<span class="keyword">this</span>.xscale)
    .y(<span class="keyword">function</span>(d) {
      thiz.timestamp = d;
      <span class="keyword">return</span> yscale(thiz.calculate().numCars);
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>area function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> area = d3.svg.area()
    .x(<span class="keyword">this</span>.xscale)
    .y0(<span class="keyword">this</span>.timeline.height)
    .y1(<span class="keyword">function</span>(d) {
      thiz.timestamp = d;
      <span class="keyword">return</span> yscale(thiz.calculate().numCars);
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>generate a range of time intervals between the start and end</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> timestamps = d3.range(+<span class="keyword">this</span>.start, <span class="keyword">this</span>.end, <span class="keyword">this</span>.interval);

  <span class="keyword">var</span> generatePath = <span class="keyword">function</span>(className, dFunction) {</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>remove any existing path first</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    thiz.timeline.selectAll(<span class="string">'path.'</span> + className).remove();
    <span class="keyword">return</span> thiz.timeline.selectAll(<span class="string">'path.'</span> + className)
      .data([timestamps])
      .enter()
      .append(<span class="string">'svg:path'</span>)
      .attr({
        <span class="string">'class'</span>: className,
        <span class="string">'d'</span>: dFunction
      });
  };

  generatePath(<span class="string">'count-area'</span>, area);</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>generatePath(&#39;count-path&#39;, path);</p>
<p>reset timestamp to beginning</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.timestamp = +<span class="keyword">this</span>.start;
};

Graph.prototype.animate = <span class="keyword">function</span>(start, speed) {
  <span class="keyword">var</span> thiz = <span class="keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>clear any existing animation loop</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> (<span class="keyword">this</span>[<span class="string">'animation'</span>] != <span class="literal">null</span>)
    <span class="keyword">this</span>.animation = clearTimeout(<span class="keyword">this</span>.animation);

  <span class="keyword">this</span>.timestamp = start || <span class="keyword">this</span>.timestamp;
  speed = speed || <span class="keyword">this</span>.speed;</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>draw all cars hidden to start</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.circles = <span class="keyword">this</span>.circles || <span class="keyword">this</span>.svg.selectAll(<span class="string">'.car'</span>)
    .data(<span class="keyword">this</span>.ids)
    .enter()
    .append(<span class="string">'svg:circle'</span>)
    .attr({
      <span class="string">'class'</span>: <span class="string">'car hide'</span>,
      <span class="string">'r'</span>: <span class="number">5</span>,
      <span class="string">'data-id'</span>: <span class="keyword">function</span>(car) {
        <span class="keyword">return</span> car;
      }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>set a timeout that can be cleared if this is being called again</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> loop = <span class="keyword">function</span>() {
    thiz.update(thiz.timestamp, speed);
    thiz.timestamp += thiz.interval;

    thiz.animation = thiz.stopAnimating == <span class="literal">true</span> ?</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>set the animation to undefined if told to stop udating</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      clearTimeout(thiz.animation) :</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>if we&#39;re at a time greater than available, stop</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      thiz.timestamp &gt; thiz.end ? clearTimeout(thiz.animation) :</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>otherwise, keep animating</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      setTimeout(loop, speed);
  };
  loop();
};</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>update the graph components and car positions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Graph.prototype.update = <span class="keyword">function</span>(timestamp, speed) {
  timestamp = timestamp || <span class="keyword">this</span>.timestamp;
  speed = speed || <span class="keyword">this</span>.speed; <span class="comment">// FIXME for 0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>don&#39;t try to update if we&#39;re at a time beyond what we&#39;ll have data for</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> (timestamp &gt; <span class="keyword">this</span>.end) <span class="keyword">return</span> <span class="keyword">this</span>.stop();</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>redraw all the cars with the current timestamp</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.updateCars(timestamp);</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>update mapreduce stats</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">this</span>.data = <span class="keyword">this</span>.calculate();</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>update text stats</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> date = <span class="keyword">new</span> Date(timestamp).inPortland();
  <span class="keyword">this</span>.day.element.text(<span class="keyword">this</span>.day.format(date));
  <span class="keyword">this</span>.time.element.text(<span class="keyword">this</span>.time.format(date));</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>update the position of the timeline marker</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> x = <span class="keyword">this</span>.xscale(timestamp);</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>only animate when we&#39;re not updating FIXME</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> marker = <span class="keyword">this</span>.timeline.select(<span class="string">'.time-marker'</span>);
  <span class="keyword">var</span> m = <span class="keyword">this</span>.stopAnimating ?
    marker : marker.transition().duration(speed).ease(<span class="string">'linear'</span>);

  m.attr({
    <span class="string">'x1'</span>: x,
    <span class="string">'x2'</span>: x
  });
}</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>updates the car positions according to the given timestamp</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Graph.prototype.updateCars = <span class="keyword">function</span>(timestamp) {
  <span class="keyword">var</span> thiz = <span class="keyword">this</span>;
  <span class="keyword">if</span> (timestamp == <span class="literal">null</span>) <span class="keyword">return</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>updates an individual car by it&#39;s id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> update = <span class="keyword">function</span>(car) {
    <span class="keyword">var</span> loc = thiz.cars[car][timestamp];
    <span class="keyword">var</span> circle = d3.select(<span class="keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>the car doesn&#39;t have a location for the timestamp</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (loc == <span class="literal">null</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>if we&#39;re not animating and the car doesn&#39;t have a location, hide it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (thiz.stopAnimating == <span class="literal">true</span>) {
        circle
          .classed(<span class="string">'moving'</span>, <span class="literal">false</span>)
          .classed(<span class="string">'hide'</span>, <span class="literal">true</span>);
        <span class="keyword">return</span>;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>else if we&#39;re already moving, don&#39;t touch</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">else</span> <span class="keyword">if</span> (circle.classed(<span class="string">'moving'</span>)) <span class="keyword">return</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>get an index of where the previous timestamp occured</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> prevTimestamp = circle.attr(<span class="string">'data-timestamp'</span>);
      <span class="keyword">var</span> index = thiz.cars[car].locations.indexOf(prevTimestamp);</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>find the next index</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> nextLocTimestamp = thiz.cars[car].locations[index + <span class="number">1</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>find the next location</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> nextLoc = thiz.cars[car][nextLocTimestamp];</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>if there is no next timestamp (ie, the car is unavailable and
there we are still looping), the car should be hidden</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (nextLoc == <span class="literal">null</span>) {
        circle.classed(<span class="string">'hide'</span>, <span class="literal">true</span>);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>if the next location found is over 2 hours away, prevent from
drifting the car slowly to it&#39;s next found location. it&#39;s not
available at the current timestamp so hide it until..</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">else</span> <span class="keyword">if</span> (+nextLocTimestamp - +prevTimestamp &gt;= (<span class="number">2</span>*Date.hour)) {
        circle.classed(<span class="string">'hide'</span>, <span class="literal">true</span>);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>transfer the car towards it&#39;s next location</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>start the car moving and show it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        circle.classed({ moving: <span class="literal">true</span>, hide: <span class="literal">false</span> });</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>the difference in intervals between the next found timestamp</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> intervals = (nextLocTimestamp - timestamp) / thiz.interval;</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>next coords</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> coords = thiz.getCoords(nextLoc);</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>start the animation to the next location</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        circle.transition()
          .ease(<span class="string">'linear'</span>)
          .duration(thiz.speed * intervals)
          .attr({
            cx: coords.x,
            cy: coords.y
          })
          .each(<span class="string">'end'</span>, <span class="keyword">function</span>() {
            d3.select(<span class="keyword">this</span>).classed(<span class="string">'moving'</span>, <span class="literal">false</span>);
          });
      }
    }
    <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>should only occur the first time the car is available, so
show it and put it in it&#39;s location</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> coords = thiz.getCoords(loc);</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>end any existing transitions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      circle.transition();</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>move the circle to it&#39;s location</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      circle</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>show the car and remove the moving class</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        .classed({ hide: <span class="literal">false</span>, moving: <span class="literal">false</span> })
        .attr({
          cx: coords.x,
          cy: coords.y,
          <span class="string">'data-timestamp'</span>: timestamp
        });
    }
  };

  <span class="keyword">this</span>.circles.each(update);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>return an { x: x, y: y } object from a single location data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Graph.prototype.getCoords = <span class="keyword">function</span>(location) {
  <span class="keyword">var</span> coords = {
    lon: location[<span class="number">0</span>],
    lat: location[<span class="number">1</span>]
  };
  <span class="keyword">return</span> map.locationPoint(coords);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>calculations on data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Graph.prototype.calculate = <span class="keyword">function</span>(data, stats) {</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>default object of data to mapreduce on</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  data = data || <span class="keyword">this</span>.cars;</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>default stats object with mappings and reductions keys </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  stats = stats || <span class="keyword">this</span>.stats || <span class="keyword">this</span>.defineStats();

  <span class="keyword">return</span> mapreduce(data, stats.mappings, stats.reductions);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>a schema to mapreduce the dataset on</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Graph.prototype.defineStats = <span class="keyword">function</span>() {
  <span class="keyword">var</span> thiz = <span class="keyword">this</span>;

  <span class="keyword">return</span> {
    mappings: {</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>boolean value if there was a location found for the current
configured timestamp</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      numCars: <span class="keyword">function</span>(car) {
        <span class="keyword">return</span> car[thiz.timestamp] != <span class="literal">null</span>;
      }
    },

    reductions: {</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>return a count for the number of cars found with a location
at the current timestamp</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      numCars: <span class="keyword">function</span>(sum, haslocation) {
        sum = sum || <span class="number">0</span>;
        <span class="keyword">if</span> (haslocation) sum += <span class="number">1</span>;
        <span class="keyword">return</span> sum;
      }
    }
  }
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
